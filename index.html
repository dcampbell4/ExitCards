<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content and Language Integrated Instruction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-10">
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-4xl w-full mx-auto p-8 lg:p-12 border border-gray-200">
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-black tracking-tight">CONTENT AND LANGUAGE INTEGRATED INSTRUCTION</h1>
        </div>

        <!-- Feedback and Takeaways Section -->
        <div id="feedback-form" class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-600">What were the two biggest takeaways from today?</h2>
            <div class="relative">
                <textarea
                    id="feedback-box"
                    class="w-full h-40 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 resize-none"
                    placeholder="Reference tools, techniques, or thinking that you can apply in the coming weeks..."
                ></textarea>
            </div>
            <button
                id="submit-feedback"
                class="w-full bg-black hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-700 focus:ring-offset-2"
            >
                Submit Exit Card
            </button>
        </div>

        <!-- Thank You Message -->
        <div id="thank-you-message" class="hidden text-center text-gray-800">
            <h2 class="text-3xl font-bold mb-4">Thank you for your participation and feedback!</h2>
            <p class="text-gray-600">Your insights have been recorded. You can close this page now.</p>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Get references to HTML elements
        const feedbackBox = document.getElementById('feedback-box');
        const submitButton = document.getElementById('submit-feedback');
        const feedbackForm = document.getElementById('feedback-form');
        const thankYouMessage = document.getElementById('thank-you-message');
        
        // Authenticate the user and set up the submission logic
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Sign in with custom token or anonymously
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                }
            }

            // Add click listener to the submit button
            submitButton.addEventListener('click', async () => {
                const feedbackText = feedbackBox.value.trim();

                if (feedbackText.length === 0) {
                    // Do nothing if the feedback is empty
                    return;
                }

                submitButton.disabled = true; // Disable button to prevent multiple submissions
                submitButton.textContent = 'Submitting...';

                try {
                    const userId = auth.currentUser?.uid;
                    if (!userId) {
                        throw new Error("User not authenticated.");
                    }

                    // Define the Firestore collection path
                    const feedbackCollection = collection(db, `artifacts/${appId}/users/${userId}/exit_cards`);
                    
                    // Add the feedback and a server timestamp to the collection
                    await addDoc(feedbackCollection, {
                        feedback: feedbackText,
                        timestamp: serverTimestamp()
                    });

                    // Hide the form and show the thank you message
                    feedbackForm.classList.add('hidden');
                    thankYouMessage.classList.remove('hidden');

                } catch (e) {
                    console.error("Error adding document: ", e);
                    alert("There was an error submitting your feedback. Please try again.");
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Exit Card';
                }
            });
        });

    </script>
</body>
</html>
